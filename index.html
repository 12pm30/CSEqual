<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="stuff, to, help, search, engines, not" name="keywords">
<meta content="What this page is about." name="description">
<meta content="Display Webcam Stream" name="title">
<title>Display Webcam Stream</title>
  
<style>
#container {
    margin: 0px auto;
    width: 500px;
    height: 375px;
    border: 10px #333 solid;
}
#videoElement {
    width: 500px;
    height: 375px;
    background-color: #666;
}
</style>
</head>
  
<body>
<div id="container">
    <video autoplay="true" id="videoElement">
    </video>
</div>
<input id="clickMe" type="button" value="Take my Photo!" onclick="takepicture();" />
<input id="recognize" type="button" value="Recognize Try!"/>	
<canvas id="canvas">
  </canvas>
  <div class="output">
    <img id="photo" alt="The screen capture will appear in this box.">
  </div>
	
  <div class="image-container" class="image-container"> </div>
	
<script type="text/javascript" src="public/js/vendor/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="public/js/vendor/ratchet.min.js"></script>
<script type="text/javascript" src="public/js/vendor/spin.min.js"></script>
<script type="text/javascript" src="public/js/audio.js"></script>
<script type="text/javascript" src="public/js/api.js"></script>
<script type="text/javascript" src="public/js/ui.js"></script>
	
<script>
	function takepicture() {
	    var video = document.getElementById('videoElement');
    	    var canvas = document.getElementById('canvas');
    	    var photo = document.getElementById('photo');
	    var context = canvas.getContext('2d');
	    var width = 500;    // We will scale the photo width to this
  	    var height = 375;     // This will be computed based on the input stream
	    var streaming = false;
	    if (width && height) {
	      canvas.width = width;
	      canvas.height = height;
	      context.drawImage(video, 0, 0, width, height);
	      var data = canvas.toDataURL('image/png');
	      var canvas = document.getElementById("canvas");
	      recognize(data);
	    } else {
	      clearphoto();
	    }
	  }
	
	function clearphoto() {
		var video = document.getElementById('videoElement');
    		var canvas = document.getElementById('canvas');
    		var photo = document.getElementById('photo');
    		var context = canvas.getContext('2d');
		var width = 320;    // We will scale the photo width to this
  		var width = 320;    // We will scale the photo width to this
  	    	var height = 0;     // This will be computed based on the input stream
	    	var streaming = false;
    		context.fillStyle = "#AAA";
    		context.fillRect(0, 0, canvas.width, canvas.height);
		
    		var data = canvas.toDataURL('image/png');
    		photo.setAttribute('src', data);
  	}
	
	function testWatsonApi() {
	  return new Promise(function (resolve, reject) {
	    var res = {};

	    const VisualRecognitionV3 =
	      require('watson-developer-cloud/visual-recognition/v3');

	    var url = 'https://sandbox-watson-proxy.mybluemix.net/visual-recognition/api' ;
	    var use_unauthenticated =  true ;

	    const visual_recognition = new VisualRecognitionV3({
	      'api_key': '',
	      'version_date': '2016-05-20',
	      'url' : url,
	      'use_unauthenticated': use_unauthenticated
	    });

	    visual_recognition.classify({'url': 'https://raw.githubusercontent.com/watson-developer-cloud/doc-tutorial-downloads/master/visual-recognition/fruitbowl.jpg'}, function(err, res) {
	      if (err)
	          document.getElementById("output2").innerHTML = err.message;
	      else
			  document.getElementById("output2").innerHTML = JSON.stringify(res, null, 2);
	    });
	  });
	}
	
</script>
<script>
	var video = document.querySelector("#videoElement");
 
	navigator.mediaDevices.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
 
	if (navigator.getUserMedia) {       
	    navigator.getUserMedia({video: true}, handleVideo, videoError);
	}
 
	function handleVideo(stream) {
	    document.querySelector('#videoElement').src = window.URL.createObjectURL(stream);
	}
 
	function videoError(e) {
	
	}
</script>

	<script>
'use strict';
$(document).ready(function() {

  var opts = {
    lines: 13, // The number of lines to draw
    length: 20, // The length of each line
    width: 10, // The line thickness
    radius: 30, // The radius of the inner circle
    corners: 1, // Corner roundness (0..1)
    rotate: 0, // The rotation offset
    direction: 1, // 1: clockwise, -1: counterclockwise
    color: '#FFF', // #rgb or #rrggbb or array of colors
    speed: 1, // Rounds per second
    trail: 60, // Afterglow percentage
    shadow: true, // Whether to render a shadow
    hwaccel: true, // Whether to use hardware acceleration
    className: 'spinner', // The CSS class to assign to the spinner
    zIndex: 2e9, // The z-index (defaults to 2000000000)
    top: '50%', // Top position relative to parent
    left: '50%' // Left position relative to parent
  };

  var spinner = new Spinner(opts);
  var player = $.AudioPlayer();

  function toTitleCase(val) {
    if (val.length > 1) {
      val = val.charAt(0).toUpperCase() + val.substr(1).toLowerCase();
    }
    return val;
  }

  function selectImage() {
    $('#picture-field').click();
  }

  function imageSelected(event) {
    clear();

    var target = event.target ? event.target : {},
      files = target.files ? target.files : [];

    if ((files.length === 1) && (files[0].type.indexOf('image/') === 0)) {
      var img = $(new Image()).attr('src', URL.createObjectURL(files[0]));
      $('#image-container').append(img);

      recognize(files[0]);

      setTimeout(function() {
        spinner.spin($('.content')[0]);
      }, 10);
    }
  }

  function speak() {
    var buffer = player.getSound();
    if (buffer !== null) {
      player.play();
    } else {
      var result = $('#image-result');
      var text = null;
      var voice = null;
      var translation = result.data('translation');
      if (translation && (translation.length > 0)) {
        text = result.data('translation');
        voice = 'es-ES_EnriqueVoice';
      } else {
        text = result.data('text');
        voice = 'en-US_MichaelVoice';
      }
      if (text && text.length > 0) {
        var request = $.api.speak(text, voice);
        $.when(request).then(function(sound) {
          player.setSound(sound);
        });
      }
    }
  }

  function recognize(file) {
    var request = $.api.recognize(file);
    $.when(request).then(translate, onError);
  }

  function translate(textObj) {
    var image = textObj.images ? textObj.images[0] : {},
      classifiers = image.classifiers || [],
      classifier = classifiers[0],
      text = classifier ? classifier.classes[0].class.replace(/_/gi,' ') : 'The image could not be recognize';

    var request = $.api.translate(text);
    $.when(request).then(function(translationObj) {
      onSuccess(textObj, translationObj);
    }, function() {
      onSuccess(textObj);
    });
  }

  function onSuccess(textObj, translationObj) {
    var image = textObj.images ? textObj.images[0] : {},
      classifiers = image.classifiers || [],
      classifier = classifiers[0],
      text = classifier ? classifier.classes[0].class.replace(/_/gi,' ') : 'The image could not be recognize',
      translation = (translationObj && translationObj.translations && translationObj.translations.length > 0) ? translationObj.translations[0].translation : '';

    var result = $('#image-result');
    result.data('text', text);
    result.data('translation', translation);

    $('h2', result).html(toTitleCase(text));
    $('h3', result).html(translation);
    result.animate({ 'bottom': '+=85px' }, 'slow');
    spinner.stop();
  }

  function onError() {
    spinner.stop();
  }

  function clear() {
    player.setSound(null);

    $('#landing').css('display', 'none');
    $('#content').css('display', 'block');

    $('#image-container').empty();

    var result = $('#image-result');
    result.data('text', null);
    result.data('translation', null);
    if (result.css('bottom') !== '-85px') {
      result.animate({
        'bottom': '-=85px'
      }, 'fast');
    }
  }

  $('#capture-button').on('click', selectImage);
  $('#picture-field').on('change', imageSelected);
  $('#play-sound').on('click', speak);

});
</script>
</body>
</html>
